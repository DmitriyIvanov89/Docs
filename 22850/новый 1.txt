В рамках данного решения в Спектрум из СУБО "Наличные операции ФЛ" будут попадать следующие операции:
Код операции	Наименование операции в Спектруме
???	Внесение на счет клиента
*??? это новый код операции, который ранее не использовался.

1.	Интеграция между Спектрум и СУБО "Наличные операции ФЛ" будет реализована через интеграционную шину IBM MQ посредствам MQ очередей. 
2.	Взаимодействие асинхронное: для взаимодействия буду использоваться MQ очереди для создания, отмены и синхронизации статуса операции (подробное описание интеграционного взаимодействия см. в ТДР по данному решению).
3.	Для интеграции с СУБО "Наличные операции ФЛ" будут использоваться следующие сервисы Спектрума:

- - - Существующий сервис JournalService(WSDL)

Входящие запросы от СУБО "Наличные операции ФЛ":

1. Создание операции:
- Состав запроса на создание операции CreateRequest-
- Маппинг значений для элемента identityCardTypeId
- Маппинг значений для элемента personCitizenCountryCode
- Состав ответа на запрос CreateResponce

2.	Отмена операции
- Состав запроса на отмену операции CancelRequest
- Состав ответа на запрос на отмену операции CancelResponce
b.	Новый сервис для отправки запросов в СУБО "Наличные операции ФЛ":
i.	Исходящие запросы из Спектрума:
1.	Синхронизация статуса операции
 Состав запроса на синхронизацию статуса операции SyncRequest
 Состав ответа на запрос синхронизации статуса операции SyncResponce
XSD-схемы и примеры сообщений для синхронизации статуса со Спектрум:

- - - Новый сервис для отправки запросов в СУБО "Наличные операции ФЛ":

1. Исходящие запросы из Спектрума:
1.1 Синхронизация статуса операции:
Состав запроса на синхронизацию статуса операции SyncRequest
Состав ответа на запрос синхронизации статуса операции SyncResponce

XSD-схемы и примеры сообщений для синхронизации статуса со Спектрум:
3.	Для взаимодействия СУБО "Наличные операции ФЛ" будет использоваться один менеджер MQ-очередей с локальными очередями. 
4.	Запросы на создание и отмену операции из СУБО "Наличные операции ФЛ" в Спектрум должны отправляться в одну очередь ANY.SPECTR.JOURNALSERVICE.Q.  
5.	В запросе на создание операции из СУБО "Наличные операции ФЛ" в Спектрум должна быть указана очередь, куда Спектрум должен отправить ответ, а именно:
	SPECTR.CONP.CRTOP.RES.Q
6.	СУБО "Наличные операции ФЛ" должен обрабатывать ответ о создании операции из очереди SPECTR.CONP.CRTOP.RES.Q.
7.	В запросе на отмену операции из СУБО "Наличные операции ФЛ" в Спектрум должна быть указана очередь, куда Спектрум должен отправить ответ, а именно:
	SPECTR.CONP.CNLOP.RES.Q
8.	СУБО "Наличные операции ФЛ" должен обрабатывать ответ об отмене операции из очереди SPECTR.CONP.CNLOP.RES.Q.
9.	Запросы на синхронизацию статуса операции из Спектрум в СУБО "Наличные операции ФЛ" должны отправляться в очередь SPECTR.CONP.SYNCOP.REQ.Q.
10.	Ответы на синхронизацию статуса от СУБО "Наличные операции ФЛ" в Спектрум должны отправляться в очередь CONP.SPECTR.SYNCOP.RES.Q.

-- 	СУБО "Наличные операции ФЛ" будет передавать в Спектрум:
id операции с индексом SP: вида  SP.CONP.12345678901234567
всегда имеет префикс SP.CONP.
длина с учетом префикса не должна превышать 25 символов
признак наличия комиссии (не входит в MVP).
Регистрация операции происходит в СУБО "Наличные операции ФЛ". В Спектруме же операция передается для:
Подтверждения в кассе
При получении запроса на создание операции из СУБО "Наличные операции ФЛ", Спектрум должен использовать текущий механизм:
Отправить запрос CheckForCredit и, в случае отсутствия ошибок, создать операцию в статусе : Не подтверждена, УСБС Операция подготовлена
Отправить запрос в СУБО "Наличные операции ФЛ" на синхронизацию статуса операции (Отменена или Не подтверждена);
Перевести операцию на кассира;
После печати ордера и подтверждения операции кассиром запустить сервис УСБС Pay.
Далее следует выгрузка проводки в ГК.

При синхронизации статуса операций (отмена, аннулирование, подтверждение) из Спектрума в СУБО "Наличные операции ФЛ" необходимо использовать следующий алгоритм:
Отправка запроса SyncCashOperationStatus из Спектрум в СУБО:
- если запрос не удалось сформировать - переход на следующий шаг сценария операции в Спектрум;
- если запрос не удалось отправить - переход на следующий шаг сценария операции в Спектрум;
После отправки запроса SyncCashOperationStatus из Спектрум - ожидание ответа в течении 10 секунд (настраиваемый параметр), 
потом повторить 2 раза (настраиваемый параметр);
- ответ так и не получен, то переход на следующий шаг сценария операции в Спектрум;
- получен ответ от СУБО "Наличные операции ФЛ":
Успешный - переход на следующий шаг сценария операции в Спектрум
Плохой - переход на следующий шаг сценария операции в Спектрум 
На этапе MVP не будет:
- операций, совершаемых 3ми лицами;
- операций с комиссией;
- конверсионных операций.
- настроек КБО (код банковской операции)
Спектрум должен провести операцию на сумму комиссии (при наличии) следующим образом:
- при получении признака комиссии от СУБО "Наличные операции ФЛ" Спектрум:
	- отправляет запрос CheckForDebit (как временное решение);
	- получает сумму комиссии;
	- проводит операцию на сумму комиссии одновременно с подтверждением основной операции по текущей технологии 
	для наличных операций по счетам Профайл (сумма комиссии).

Сумма комиссии (при наличии) будет получена Спектрумом (на этапе MVP будет получена Спектрумом не из СУБО).
На период MVP должна быть поддержка работы только с главной книгой Бисквит.
По операциям из СУБО "Наличные операции ФЛ" выгрузку в КХД делает Спектрум, по текущей технологии для наличных операций по счетам Профайл.
После подтверждения операции Спектрум в он-лайне создает в Бисквит через существующий механизм SCCreateDocs в филиале проведения операции расходный кассовый ордер 
- проводка  Дт касса Кт 47423* (где Rn 47423 - технический счет, счет для счетов в Профайле).

Офлайн выгрузка в Агрегатор производится по текущей технологии аналогично операциям по счетам Профайл.
По операциям из СУБО "Наличные операции ФЛ" со стороны Спектрума необходима поддержка работы с РКО и справкой с НИВ для валютных операций.
Для случаев, когда операция попала в ручное урегулирование в Спектруме, информация в СУБО "Наличные операции ФЛ" будет отправлена ДО урегулирования.
Отдельного журнала ручного урегулирования с СУБО в Спектруме не требуется. 
При не успешной попытке синхронизации статуса операции от Спектрума должны автоматически производится ещё две попытки и на этом конец, в СУБО "Наличные операции ФЛ" будет возможность перевода операции в конечный статус.
Аннулирование операций на этапе MVP реализовываться не будет. Аннулирование операций возможно лишь при получении ошибок на запросы hold, post.
Нотификация по недовыгруженным операциям аналогична работе с Профайлом.

Выгрузки операций 1010 / 1011 по текущей технологии:

1010	Операции, аннулирование которых запрещено	-3
1011	Операции, аннулирование которых запрещено	-3
1010	Операции, требующие дополнительного контроля	3
1011	Операции, требующие дополнительного контроля	3
1010	Операции по счетам/картам Profile	4
1011	Операции по счетам/картам Profile	4
1010	Операции первого потока 1	-7
1011	Операции первого потока 1	-7
1010	Нотификация по операциям, требующим ручного урегулирования в ПО Спектрум	18
1011	Нотификация по операциям, требующим ручного урегулирования в ПО Спектрум	18
1010	УРМ ЭксТКБ, 30222, пополнение ПК в БИС, наличные операции Profile	-23
1011	УРМ ЭксТКБ, 30222, пополнение ПК в БИС, наличные операции Profile	-23


Суммы операции при конверсии: 
В операциях списания со счета ФЛ суммой операции является одна из сумм (списания/выплаты), она определяется по правилу:
в случае RUB ->CUR: сумма операции=суммы выплаты в CUR,
в случае CUR->RUB: сумма операции=суммы списания в CUR,
в случае CUR1->CUR2 (например, USD->EUR): сумма операции=суммы выплаты в CUR2.
При ручном изменении суммы, не являющейся суммой операции:
в случае RUB ->CUR суммы списания в RUB,
в случае CUR->RUB суммы выплаты в RUB,
в случае CUR1->CUR2 (например, USD->EUR) суммы списания в CUR1


- выгрузки в смежные системы(КХД,армсэд);
- ssl;
- отмена операции;
- коды по 136И;
- 

execError=#ULBS421-01#

********************************************
22774

Определяется система ведения вклада на основе переданной информации из Siebel (тег SiebelAccountSystemId)

audience="developer"

3201000 Выдача наличных средств со вклада (без закрытия)
3202000 Выдача наличных средств со вклада (с закрытием)
3501000 Выплата страхового возмещения АСВ наличными

1051.BQ Выплата страхового возмещения АСВ наличными
1051.CFT Выплата страхового возмещения АСВ наличными

-- 1240.BQ Выдача с рублевого вклада в БИСквит (без закрытия)
-- 1240.CFT Выдача с рублевого вклада (без закрытия)
-- 1241.BQ Выдача с валютного вклада БИСквит (без закрытия) в рублях
-- 1241.CFT Выдача с валютного вклада (без закрытия) в рублях
-- 1242.BQ Выдача с валютного вклада БИСквит (без закрытия) в валюте
-- 1242.CFT Выдача с валютного вклада (без закрытия) в валюте

-- 1243.BQ Выдача с рублевого вклада в БИСквит (с закрытием)
-- 1243.CFT Выдача с рублевого вклада (с закрытием)
-- 1244.BQ Выдача с валютного вклада БИСквит (с закрытием) в рублях
-- 1244.CFT Выдача с валютного вклада (с закрытием) в рублях
-- 1245.BQ Выдача с валютного вклада БИСквит (с закрытием)
-- 1245.CFT Выдача с валютного вклада (с закрытием)


В данной задаче реализуются требования FRSOF-892 "Проект 792. Интеграция УФО Спектрум и ЦФТ2.0Main - Выплаты страхового возмещения АСВ и работа со вкладами".


Проводка бисквит:
1240.BQ
-40817
-20202

1240.CTF
-
-

операции .BQ в выгрузке проводка и в Бисквит и в Main 40817 / 20202

операции .CFT в выгрузке проводка:

Бисквит: 47422 / 20202
ЦФТ: 	 40817 / 20202

ABC
Бисквит:
BQ - <Debet>47423810100003609868 - <Credit>20202810011260000001
CFT - <Debet>47422810100000000003 - <Credit>20202810011260000001

ЦФТ:
BQ - <SACCOUNTFROM>47423810100003609868 - 20202810011260000001
CFT - <SACCOUNTFROM>4078100000000 - 20202810011260000001



Если произведено успешное зачисления средств на счет клиента, выполняется выгрузка в главную книгу проводки:
Бисквит Дт касса Кт 47423*;
ЦФТ2.0 Main Дт касса Кт 40817*.

<para>Подробнее см. <xref linkend="settings.operation"/>;</para>

select operation_code, operation_name from operation where operation_code in 
('1051.BQ','1051.CFT', '1240.BQ', '1240.CFT','1241.BQ', '1241.CFT', '1242.BQ', '1242.CFT', '1243.BQ', '1243.CFT', '1244.BQ', '1244.CFT', '1245.BQ', '1245.CFT');