Алгоритм расчета итогового остатка, в пределах которого можно продавать валюту для ТП и Филиала.
 
1. при проведении приходных операций с наличной иностранной валютой и конверсии (по Дт валютная касса) (коды согласно реестру с НИВ: 01 03 14 60 61) итоговый остаток, в пределах которого можно продать валюту, как при проведении операции с обычным клиентом, так и с VIP-клиентом, должен увеличиться:
 
  1.1 для ТП на величину разности суммы операции и процента зарезервированной валюты от суммы операции:
 
      Величина увеличения итогового остатка = Сумма операции - (Сумма операции * Процент зарезервированной валюты /100);
 
  1.2 для Филиала на величину процента зарезервированной валюты от суммы операции:
 
      Величина увеличения итогового остатка = Сумма операции * Процент зарезервированной валюты /100.
 
2. при проведении расходных операций с наличной иностранной валюты и конверсии (по Кт валютная касса) (коды согласно реестру с НИВ 02 03) :
 
  2.1 для ТП при регистрации операции выполняется проверка доступного остатка по валюте операции:
 
      2.1.1 если в ТП НЕ включен режим учета операций продажи валюты (при обращении VIP клиента) - проверка пройдена успешно. Итоговый остаток для ТП не меняется, вся сумма списывается с Филиала;
 
      2.1.2 если в ТП включен режим учета операций продажи валюты и сумма операции НЕ превышает доступный остаток для ТП - проверка пройдена успешно.
      Итоговый остаток должен уменьшиться на величину разности суммы операции и процента зарезервированной валюты от суммы операции:
 
        Величина уменьшения итогового остатка = Сумма операции - (Сумма операции * Процент зарезервированной валюты / 100);
 
      2.1.3 если в ТП включен режим учета операций продажи валюты и сумма операции превышает доступный для ТП итоговый остаток по валюте операции - на экранной форме регистрации операции выдается сообщение об ошибке, дальнейшее проведение операции не возможно.
 
2.2 для Филиала:
 
    2.2.1 если в ТП включен режим учета операций продажи валюты(обращение обычного клиента) - итоговый остаток должен уменьшиться на процент зарезервированной валюты от суммы операции;
 
    2.2.2 если в ТП НЕ включен режим учета операций продажи валюты (при обращении VIP клиента) - итоговый остаток должен уменьшиться на всю сумму операции.


Ольга, добрый день!

После вчерашней встречи, относительно комментариев по описанию алгоритма расчета итогового остатка, направляю для рассмотрения другой вариант. Посмотрите, пожалуйста, понятно ли, или перемудрил опять?)